<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Agenda Medicina - Turma H</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#007bff">

    <style>
        :root { --p-med: #007bff; --bg: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --shadow: rgba(0,0,0,0.5); --input-bg: #2d2d2d; }
        [data-theme="light"] { --bg: #f4f7f6; --card-bg: #ffffff; --text-color: #333333; --shadow: rgba(0,0,0,0.1); --input-bg: #eeeeee; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text-color); transition: background 0.3s; padding-bottom: 60px; }

        /* Splash */
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; transition: opacity 0.8s ease; }
        .logo-pulsando { width: 120px; animation: pulsar 2s infinite ease-in-out; }
        @keyframes pulsar { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        .header { text-align: center; margin-bottom: 20px; }
        #status-bar { font-size: 0.8em; color: #888; margin-top: 5px; }
        
        /* Grid */
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: var(--card-bg); height: 110px; border-radius: 15px; box-shadow: 0 4px 6px var(--shadow); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 600; border: 1px solid rgba(255,255,255,0.05); }
        .card .icon { font-size: 1.8em; margin-bottom: 8px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); align-items: center; justify-content: center; padding: 15px; z-index: 2000; backdrop-filter: blur(8px); }
        .modal-content { background: var(--card-bg); padding: 20px; border-radius: 25px; width: 100%; max-width: 450px; max-height: 85vh; overflow-y: auto; position: relative; border: 1px solid rgba(0,123,255,0.3); }
        .close-btn { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 28px; color: var(--text-color); }
        
        /* Listas e Grade */
        .secao-retratil { margin-bottom: 12px; border-radius: 15px; background: rgba(255,255,255,0.03); border: 1px solid var(--shadow); overflow: hidden; }
        .secao-titulo { background: rgba(0,123,255,0.12); color: var(--p-med); padding: 14px 18px; font-weight: 800; font-size: 0.85em; text-transform: uppercase; cursor: pointer; display: flex; justify-content: space-between; align-items: center; list-style: none; }
        .secao-titulo::-webkit-details-marker { display: none; }

        .grade-item { display: flex; align-items: center; gap: 12px; padding: 12px 15px; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .grade-hora { flex: 0 0 100px; color: #fff; font-weight: 800; font-size: 0.75em; text-align: center; background: var(--p-med); padding: 5px; border-radius: 6px; }
        .grade-info { flex: 1; text-align: left; }
        
        .item-lista { display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--input-bg); border-radius: 12px; margin: 8px 0; text-decoration: none; color: var(--text-color); width: 100%; }
        .arquivo-nome { font-weight: bold; text-align: left; flex: 1; margin-right: 10px; }
        .link-vazio { color: #ffa500; font-size: 0.75em; font-style: italic; white-space: nowrap; }

        #theme-toggle { position: fixed; bottom: 25px; right: 25px; background: var(--card-bg); border: 2px solid var(--p-med); border-radius: 50%; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; z-index: 999; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    </style>
</head>
<body data-theme="dark">

<div id="splash">
    <img src="logo_UCP.png" class="logo-pulsando" onerror="this.src='https://via.placeholder.com/150?text=MED+UCP'">
    <h2 style="color:#007bff; margin-top: 15px; font-weight: 900;">MEDICINA - UCP</h2>
</div>

<button id="theme-toggle" onclick="toggleTheme()"><span id="theme-icon">üåô</span></button>

<div class="header">
    <h2 style="margin:0; letter-spacing: -1px;">Medicina - Turma H</h2>
    <div id="status-bar">Sincronizando...</div>
</div>

<div class="grid-container">
    <div class="card" onclick="abrirGrade()"><span class="icon">üìÖ</span><span>Grade</span></div>
    <div class="card" onclick="abrirGrupos()"><span class="icon">üë•</span><span>Grupos</span></div>
    <div class="card" onclick="abrirAvisos()"><span class="icon">üîî</span><span>Avisos</span></div>
    <div class="card" onclick="abrirArquivos()"><span class="icon">üìÑ</span><span>Arquivos</span></div>
    <div id="btnAulasOnline" class="card" onclick="abrirLinks()" style="grid-column: span 2; height: 85px; flex-direction: row; gap: 15px;">
        <span class="icon">üíª</span><span>Aulas Online</span>
    </div>
</div>

<div id="meuModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="fecharModal()">‚úï</button>
        <h3 id="modal-titulo" style="margin-bottom:20px; color:var(--p-med); padding-right: 30px;"></h3>
        <div id="modal-corpo"></div>
    </div>
</div>

<div id="modalAdmin" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="fecharAdmin()">‚úï</button>
        <h3 style="color:#28a745;">Painel Administrativo</h3>
        <p>Acesso: <b>Jo√£o Sanchez</b></p>
    </div>
</div>

<div class="footer-creditos" id="btnAdmin" style="text-align: center; font-size: 11px; color: #888; margin-top: 40px; cursor: pointer;">
    Desenvolvido por Jo√£o Vitor Fr√≥is Sanchez
</div>

<script>
    const URL_API = "https://script.google.com/macros/s/AKfycbxDt1R5Gpu2aDY5dts6aDQcigKLx28ZxjmXynrvOvmGmvwaG86xBQmOABbn_BsKsUNP7A/exec";
    let dadosApp = {};
    let timerAdmin;
    let timerPlanilha; // Vari√°vel global para o timer

    function setupAccordion(grupo) {
        const detalhes = document.querySelectorAll(`details[name="${grupo}"]`);
        detalhes.forEach(targetDetail => {
            targetDetail.onclick = (e) => {
                detalhes.forEach(detail => {
                    if (detail !== targetDetail) detail.removeAttribute("open");
                });
            };
        });
    }

    function formatarDataBR(dataStr) {
        if(!dataStr) return "";
        const d = new Date(dataStr);
        if(isNaN(d.getTime())) return dataStr;
        return d.toLocaleDateString('pt-BR');
    }

    // Configura√ß√£o Admin do Footer
    const btnAdminDiv = document.getElementById('btnAdmin');
    ['touchstart', 'mousedown'].forEach(evt => btnAdminDiv.addEventListener(evt, () => timerAdmin = setTimeout(() => document.getElementById('modalAdmin').style.display='flex', 5000)));
    ['touchend', 'mouseup', 'mouseleave'].forEach(evt => btnAdminDiv.addEventListener(evt, () => clearTimeout(timerAdmin)));
    
    function fecharAdmin() { document.getElementById('modalAdmin').style.display = 'none'; }

    async function carregarDados() {
        try {
            const res = await fetch(`${URL_API}?t=${new Date().getTime()}`);
            dadosApp = await res.json();
            localStorage.setItem('med_h_cache', JSON.stringify(dadosApp));
            document.getElementById('status-bar').innerText = `Atualizado: ${dadosApp.ultima_sincronizacao || 'Agora'}`;
        } catch (e) {
            dadosApp = JSON.parse(localStorage.getItem('med_h_cache') || "{}");
            document.getElementById('status-bar').innerText = "Modo Offline";
        }
    }

    // Fun√ß√µes de Modal (Grade, Avisos, etc - Mesma l√≥gica)
    function abrirGrade() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Grade de Aulas";
        corpo.innerHTML = "";
        const itens = dadosApp["Grade"] || [];
        const ordemReferencia = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado", "Domingo"];
        const diasDaPlanilha = [...new Set(itens.map(a => a["Dia da Semana"]))].sort((a, b) => {
            return ordemReferencia.findIndex(dia => a.includes(dia)) - ordemReferencia.findIndex(dia => b.includes(dia));
        });
        diasDaPlanilha.forEach(dia => {
            const aulas = itens.filter(a => a["Dia da Semana"] === dia);
            let htmlAulas = aulas.map(a => `<div class="grade-item"><div class="grade-hora">${a["Hor√°rios"] || '--:--'}</div><div class="grade-info"><span style="font-weight:bold; font-size:0.95em; display:block;">${a["Mat√©ria"]}</span><span style="font-size:0.7em; opacity:0.6;">üë• ${a["Grupo"] || 'Geral'}</span></div></div>`).join('');
            corpo.innerHTML += `<details class="secao-retratil" name="grade"><summary class="secao-titulo">${dia} <span>‚ñæ</span></summary><div>${htmlAulas}</div></details>`;
        });
        document.getElementById('meuModal').style.display = 'flex';
        setupAccordion("grade");
    }

    function abrirAvisos() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Avisos";
        const itens = dadosApp["Avisos"] || [];
        corpo.innerHTML = itens.slice().reverse().map(i => `<div style="background:rgba(0,123,255,0.05); padding:15px; border-radius:12px; margin-bottom:12px; border-left: 4px solid var(--p-med);"><div style="font-size: 0.75em; color: #888; margin-bottom: 2px;">${formatarDataBR(i["Data"])}</div><div style="font-weight: 800; color: var(--p-med); font-size: 0.85em; margin-bottom: 8px; text-transform: uppercase;">${i["Titulo"]}</div><div style="font-size: 1em; line-height: 1.4; white-space: pre-wrap;">${String(i["Mensagem"] || "")}</div></div>`).join('');
        document.getElementById('meuModal').style.display = 'flex';
    }

    function abrirArquivos() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Arquivos";
        corpo.innerHTML = "";
        const itens = dadosApp["Arquivos"] || [];
        const nomesMaterias = [...new Set(itens.map(i => i["Nome"]))];
        nomesMaterias.forEach(n => {
            const links = itens.filter(i => i["Nome"] === n);
            let html = links.map(a => {
                const temLink = a["Links"] && String(a["Links"]).includes("http");
                return `<${temLink ? 'a href="'+a["Links"]+'" target="_blank"' : 'div'} class="item-lista"><span class="arquivo-nome">${a["Descri√ß√£o"]}</span>${temLink ? '<span>üìÇ</span>' : '<span class="link-vazio">‚è≥ Aguardando links</span>'}</${temLink ? 'a' : 'div'}>`;
            }).join('');
            corpo.innerHTML += `<details class="secao-retratil" name="arqs"><summary class="secao-titulo">${n} <span>‚ñæ</span></summary><div style="padding:5px 10px;">${html}</div></details>`;
        });
        document.getElementById('meuModal').style.display = 'flex';
        setupAccordion("arqs");
    }

    function abrirGrupos() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Grupos";
        corpo.innerHTML = `<div id="container-grupos"></div>`;
        const lista = dadosApp["Grupos"] || [];
        const materias = [...new Set(lista.map(i => i["Mat√©ria"]))];
        materias.forEach(mat => {
            const gruposMat = lista.filter(i => i["Mat√©ria"] === mat);
            const nomesG = [...new Set(gruposMat.map(g => g["Nome do Grupo"]))];
            let htmlGrupos = nomesG.map(ng => {
                const membros = gruposMat.filter(g => g["Nome do Grupo"] === ng).map(m => `<li>${m["Integrantes"]}</li>`).join('');
                return `<details style="margin:5px 0; border:1px solid rgba(128,128,128,0.2); border-radius:10px;"><summary style="padding:10px; font-size:0.9em;">${ng}</summary><ul style="font-size:0.85em; color:#bbb; padding-bottom:10px;">${membros}</ul></details>`;
            }).join('');
            document.getElementById('container-grupos').innerHTML += `<details class="secao-retratil" name="gps"><summary class="secao-titulo">${mat} <span>‚ñæ</span></summary><div style="padding:10px;">${htmlGrupos}</div></details>`;
        });
        document.getElementById('meuModal').style.display = 'flex';
        setupAccordion("gps");
    }

    // FUN√á√ÉO AULAS ONLINE COM L√ìGICA DE CORES
    function abrirLinks() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Portal de Aulas Online";
        const itens = dadosApp["Links"] || [];
        
        if (itens.length === 0) {
            corpo.innerHTML = "<p style='text-align:center; opacity:0.5; padding:20px;'>Nenhum link agendado.</p>";
        } else {
            corpo.innerHTML = itens.map(i => {
                const agora = new Date();
                
                // 1. Limpeza dos dados vindos da planilha
                // Remove espa√ßos extras e garante que o hor√°rio tenha formato HH:MM
                const strData = String(i["Data"]).split('T')[0]; // Pega apenas a parte da data YYYY-MM-DD
                const strHora = String(i["Hor√°rio"]).trim();
                
                let dataAula;

                // 2. Tenta montar a data combinando os dois campos
                if (strData.includes('/') && strHora.includes(':')) {
                    // Formato DD/MM/AAAA + HH:MM
                    const [dia, mes, ano] = strData.split('/');
                    const [hora, minuto] = strHora.split(':');
                    dataAula = new Date(ano, mes - 1, dia, hora, minuto);
                } else if (strData.includes('-') && strHora.includes(':')) {
                    // Formato AAAA-MM-DD (Padr√£o Google) + HH:MM
                    const [ano, mes, dia] = strData.split('-');
                    const [hora, minuto] = strHora.split(':');
                    dataAula = new Date(ano, mes - 1, dia, hora, minuto);
                } else {
                    // Fallback para qualquer outro formato
                    dataAula = new Date(i["Data"]);
                }

                // 3. Formata√ß√£o para exibi√ß√£o amig√°vel
                const d = dataAula.getDate().toString().padStart(2, '0');
                const m = (dataAula.getMonth() + 1).toString().padStart(2, '0');
                const a = dataAula.getFullYear();
                const hh = dataAula.getHours().toString().padStart(2, '0');
                const mm = dataAula.getMinutes().toString().padStart(2, '0');
                
                const exibicaoCompleta = `${d}/${m}/${a} - ${hh}:${mm}`;

                let statusHtml = "", btnCor = "#6c757d", textoBtn = "LINK INDISPON√çVEL";

                // 4. L√≥gica de Status baseada no hor√°rio real
                if (agora >= dataAula) {
                    statusHtml = '<span style="color:#28a745; font-size:0.7em; font-weight:bold;">‚óè AO VIVO</span>';
                    btnCor = "#28a745"; 
                    textoBtn = "ACESSAR AULA AGORA";
                } else {
                    statusHtml = `<span style="color:#ffa500; font-size:0.7em; font-weight:bold;">‚åõ AGENDADA</span>`;
                    btnCor = "#007bff"; 
                    textoBtn = "ABRIR LINK";
                }

                return `<div class="item-lista" style="flex-direction:column; align-items:flex-start; border-left: 5px solid ${btnCor};">
                    <div style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                        <b style="color:var(--p-med); font-size:1.1em;">${i["Materia"]}</b>
                        ${statusHtml}
                    </div>
                    <div style="margin: 5px 0; font-size:0.85em; opacity:0.8;">
                        üóìÔ∏è ${exibicaoCompleta}
                    </div>
                    <a href="${i["Url"].startsWith('http') ? i["Url"] : 'https://' + i["Url"]}" target="_blank" style="background:${btnCor}; color:white; text-decoration:none; padding:12px; border-radius:10px; width:100%; text-align:center; font-weight:bold; margin-top:10px; display:block;">${textoBtn}</a>
                </div>`;
            }).join('');
        }
        document.getElementById('meuModal').style.display = 'flex';
    }
    function fecharModal() { document.getElementById('meuModal').style.display = 'none'; }

    function toggleTheme() {
        const n = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', n);
        document.getElementById('theme-icon').innerText = n === 'dark' ? 'üåô' : 'üí°';
        localStorage.setItem('med_h_theme', n);
    }

    window.onload = () => {
        const t = localStorage.getItem('med_h_theme') || 'dark';
        document.body.setAttribute('data-theme', t);
        carregarDados();

        // L√ìGICA DO TOQUE LONGO NO BOT√ÉO AULAS ONLINE (3 SEGUNDOS)
        const btnAulas = document.getElementById('btnAulasOnline');
        if(btnAulas) {
            ['touchstart', 'mousedown'].forEach(evt => btnAulas.addEventListener(evt, () => {
                timerPlanilha = setTimeout(() => {
                    // SEU LINK DA PLANILHA AQUI
                    window.open("https://docs.google.com/spreadsheets/d/1dQr8rqCfIyGqfkEIQCzqgxxKjsamDP3Nt4SpYu76D1o/edit?gid=968241645#gid=968241645", "_blank");
                }, 3000);
            }));
            ['touchend', 'mouseup', 'mouseleave'].forEach(evt => btnAulas.addEventListener(evt, () => clearTimeout(timerPlanilha)));
        }

        setTimeout(() => { 
            const s = document.getElementById('splash');
            if(s) { s.style.opacity = '0'; setTimeout(() => s.style.display = 'none', 800); }
        }, 1800);
    };
</script>
</body>
</html>


