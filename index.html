<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Agenda Medicina - Turma H</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Medicina - Turma H">
    <meta name="theme-color" content="#007bff">

    <link rel="manifest" href="manifest.json?v=16">
    <link rel="apple-touch-icon" href="icon.png?v=16">
    <link rel="icon" type="image/png" href="icon.png?v=16">

    <style>
        
        :root { --p-med: #007bff; --bg: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0; --shadow: rgba(0,0,0,0.5); --input-bg: #2d2d2d; --danger: #ff3b30; }
        [data-theme="light"] { --bg: #f4f7f6; --card-bg: #ffffff; --text-color: #333333; --shadow: rgba(0,0,0,0.1); --input-bg: #eeeeee; }
        
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text-color); transition: background 0.3s; padding-bottom: 100px; overflow-x: hidden; width: 100vw; }

        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; transition: opacity 0.8s ease; }
        .logo-pulsando { width: 120px; animation: pulsar 2s infinite ease-in-out; }
        @keyframes pulsar { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        .header { text-align: center; margin-bottom: 20px; cursor: pointer; }
        #status-bar { font-size: 0.75em; color: #888; margin-top: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { position: relative; background: var(--card-bg); height: 110px; border-radius: 18px; box-shadow: 0 4px 12px var(--shadow); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 700; border: 1px solid rgba(255,255,255,0.05); }
        .card .icon { font-size: 2em; margin-bottom: 8px; }

        .badge { display: none; position: absolute; top: 12px; right: 12px; width: 14px; height: 14px; background-color: var(--danger); border-radius: 50%; border: 2px solid var(--card-bg); animation: jump 0.5s infinite alternate; }
        @keyframes jump { from { transform: translateY(0); } to { transform: translateY(-3px); } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); align-items: center; justify-content: center; padding: 15px; z-index: 2000; backdrop-filter: blur(10px); }
        .modal-content { background: var(--card-bg); padding: 25px; border-radius: 28px; width: 95%; max-width: 450px; max-height: 90vh; overflow-y: auto; position: relative; border: 1px solid rgba(0,123,255,0.2); text-align: left !important; }
        
        #modal-titulo { text-align: left !important; display: block; width: 100%; margin-bottom: 20px; color: var(--p-med); font-weight: 800; font-size: 1.4em; }

        .close-btn { position: absolute; top: 15px; right: 20px; background: #333; border: none; font-size: 20px; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 10; }
        /* Bloqueia a sele√ß√£o e a lupa no bot√£o de aulas e no nome */
        #btnAulasOnline, #meuNome {
           -webkit-user-select: none;  /* Safari e Chrome Mobile */
           -moz-user-select: none;     /* Firefox */
           -ms-user-select: none;      /* IE/Edge */
           user-select: none;          /* Padr√£o */
           -webkit-touch-callout: none; /* Bloqueia o menu de "copiar/lupa" no iOS */
        }
        /* ESTILO DO AGUARDANDO AULAS - ADICIONE ISSO */
        .item-aguardando { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 15px 10px; 
            background: rgba(255, 255, 255, 0.02); 
            border: 1px dashed rgba(0, 123, 255, 0.3); 
            border-radius: 18px; 
            color: #888; 
            margin: 8px; 
            font-style: italic; 
            font-size: 0.75em; 
            text-align: center !important; 
            gap: 6px;
        }

        .item-aguardando span:first-child { font-size: 1.4em; } /* Tamanho do Emoji */
        /* AJUSTE FORMUL√ÅRIOS ADMIN */
        .admin-form { display: flex; flex-direction: column; gap: 12px; width: 100%; }
        .admin-form input, .admin-form textarea { 
            width: 100%; 
            padding: 14px; 
            border-radius: 14px; 
            border: 1px solid #444; 
            background: var(--input-bg); 
            color: var(--text-color); 
            font-size: 17px; /* Texto maior para leitura f√°cil */
            text-align: left;
            -webkit-appearance: none;
        }
        .admin-btn { width: 100%; padding: 16px; background: var(--p-med); color: white; border: none; border-radius: 14px; font-weight: bold; font-size: 16px; margin-top: 10px; cursor: pointer; }

        /* ASSINATURA DO DESENVOLVEDOR */
        .footer-creditos { 
            text-align: center; 
            font-size: 10px; 
            color: #666; 
            margin-top: 80px; /* Bem longe dos bot√µes */
            padding: 15px; 
            width: 100%; 
            opacity: 0.5;
            letter-spacing: 0.5px;
            user-select: none;
        }

        /* OUTROS ESTILOS */
        .secao-retratil { margin-bottom: 10px; border-radius: 15px; background: rgba(255,255,255,0.03); border: 1px solid rgba(0,123,255,0.1); overflow: hidden; width: 100%; }
        .secao-titulo { background: rgba(0,123,255,0.15); color: #4dabff; padding: 16px; font-weight: 800; font-size: 0.85em; text-transform: uppercase; cursor: pointer; display: flex !important; justify-content: space-between !important; align-items: center; list-style: none; text-align: left !important; }
        .grade-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid rgba(128,128,128,0.1); background: rgba(0,0,0,0.1); text-align: left !important; }
        .grade-hora { flex: 0 0 88px; height: 42px; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 800; font-size: 0.62em; background: var(--p-med); border-radius: 10px; line-height: 1.1; }
        .item-lista-link { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--input-bg); border-radius: 12px; text-decoration: none; color: inherit; margin-bottom: 8px; text-align: left !important; }

        #theme-toggle { position: fixed; bottom: 25px; right: 25px; background: var(--card-bg); border: 2px solid var(--p-med); border-radius: 50%; width: 55px; height: 55px; display: flex; align-items: center; justify-content: center; z-index: 999; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        #ptr { text-align: center; height: 0; overflow: hidden; transition: height 0.2s; color: var(--p-med); font-size: 0.8em; font-weight: bold; line-height: 40px; }
    </style>
</head>
<body data-theme="dark">

<div id="ptr">Solte para atualizar...</div>

<div id="splash">
    <img src="logo_UCP.png" class="logo-pulsando" onerror="this.src='https://via.placeholder.com/150?text=MED+UCP'">
    <h2 style="color:#007bff; margin-top: 15px; font-weight: 900;">MEDICINA - UCP</h2>
</div>

<button id="theme-toggle" onclick="toggleTheme()"><span id="theme-icon">üåô</span></button>

<div class="header" onclick="carregarDados()">
    <h2 style="margin:0; letter-spacing: -1px;">Medicina - Turma H</h2>
    <div id="status-bar">Sincronizando...</div>
</div>

<div class="grid-container">
    <div class="card" onclick="abrirGrade()"><span class="icon">üìÖ</span><span>Grade</span></div>
    <div class="card" onclick="abrirGrupos()"><span class="icon">üë•</span><span>Grupos</span></div>
    <div class="card" onclick="abrirAvisos()">
        <div id="aviso-badge" class="badge"></div>
        <span class="icon">üîî</span><span>Avisos</span>
    </div>
    <div class="card" onclick="abrirArquivos()"><span class="icon">üìÑ</span><span>Arquivos</span></div>
    <div id="btnAulasOnline" class="card" onclick="abrirLinks()" style="grid-column: span 2; height: 85px; flex-direction: row; gap: 15px;">
        <span class="icon">üíª</span><span>Aulas Online</span>
    </div>
</div>

<div id="meuModal" class="modal">
    <div class="modal-content">
        <button class="close-btn" onclick="fecharModal()">‚úï</button>
        <h3 id="modal-titulo"></h3>
        <div id="modal-corpo"></div>
    </div>
</div>

<div class="footer-creditos" id="meuNome">
    Desenvolvido por Jo√£o Vitor Fr√≥is Sanchez
</div>

<script>
    const URL_API = "https://script.google.com/macros/s/AKfycbxDt1R5Gpu2aDY5dts6aDQcigKLx28ZxjmXynrvOvmGmvwaG86xBQmOABbn_BsKsUNP7A/exec";
    let dadosApp = JSON.parse(localStorage.getItem('med_h_cache') || "{}");

    window.onload = () => {
        carregarDados();
        setupPullToRefresh();
        setupLongPress();
        setTimeout(() => {
            document.getElementById('splash').style.opacity = '0';
            setTimeout(() => document.getElementById('splash').style.display = 'none', 800);
        }, 2000);
    };

    async function carregarDados() {
        const status = document.getElementById('status-bar');
        status.innerText = "Sincronizando...";
        try {
            const res = await fetch(`${URL_API}?t=${new Date().getTime()}`);
            dadosApp = await res.json();
            localStorage.setItem('med_h_cache', JSON.stringify(dadosApp));
            status.innerText = `Atualizado: ${new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'})}`;
            verificarNovosAvisos();
        } catch (e) {
            status.innerText = "Modo Offline";
            verificarNovosAvisos();
        }
    }

    function fecharModal() { 
        document.getElementById('meuModal').style.display = 'none'; 
        carregarDados(); 
    }

    function toggleTheme() {
        const n = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', n);
        document.getElementById('theme-icon').innerText = n === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        carregarDados(); 
    }

    function verificarNovosAvisos() {
        const avisos = dadosApp["Avisos"] || [];
        const lidos = parseInt(localStorage.getItem('avisos_lidos') || "0");
        document.getElementById('aviso-badge').style.display = (avisos.length > lidos) ? 'block' : 'none';
    }

    function setupLongPress() {
    const configurar = (id, callback) => {
        let timer;
        const el = document.getElementById(id);
        
        // Impede que o menu de contexto (lupa/copiar) apare√ßa
        el.oncontextmenu = function(e) { e.preventDefault(); e.stopPropagation(); return false; };

        const start = () => { timer = setTimeout(callback, 5000); };
        const cancel = () => { clearTimeout(timer); };

        el.addEventListener('mousedown', start);
        el.addEventListener('touchstart', start);
        el.addEventListener('mouseup', cancel);
        el.addEventListener('touchend', cancel);
    };
    
    configurar('btnAulasOnline', abrirPainelLinks);
    configurar('meuNome', abrirPainelAvisos);
}

    function abrirPainelLinks() {
        document.getElementById('modal-titulo').innerText = "Postar Aula";
        document.getElementById('modal-corpo').innerHTML = `
            <div class="admin-form">
                <input type="password" id="adm-senha" placeholder="Senha de Acesso">
                <input type="text" id="adm-data" placeholder="Data (Ex: 15/05)">
                <input type="text" id="adm-hora" placeholder="Hor√°rio (Ex: 19:00)">
                <input type="text" id="adm-materia" placeholder="Nome da Mat√©ria">
                <input type="text" id="adm-url" placeholder="Link da Aula (URL)">
                <button class="admin-btn" onclick="publicar('Links')">PUBLICAR AULA</button>
                <p id="adm-status" style="text-align:center; font-size:14px; margin-top:5px;"></p>
            </div>`;
        document.getElementById('meuModal').style.display = 'flex';
    }

    function abrirPainelAvisos() {
        document.getElementById('modal-titulo').innerText = "Novo Aviso";
        document.getElementById('modal-corpo').innerHTML = `
            <div class="admin-form">
                <input type="password" id="adm-senha" placeholder="Senha de Acesso">
                <input type="text" id="adm-titulo" placeholder="T√≠tulo do Aviso">
                <textarea id="adm-msg" placeholder="Digite a mensagem aqui..." rows="5"></textarea>
                <button class="admin-btn" onclick="publicar('Avisos')">PUBLICAR AVISO</button>
                <p id="adm-status" style="text-align:center; font-size:14px; margin-top:5px;"></p>
            </div>`;
        document.getElementById('meuModal').style.display = 'flex';
    }

    async function publicar(aba) {
        const status = document.getElementById('adm-status');
        const payload = { senha: document.getElementById('adm-senha').value, aba: aba };
        if(aba === 'Links') {
            payload.data = document.getElementById('adm-data').value;
            payload.horario = document.getElementById('adm-hora').value;
            payload.materia = document.getElementById('adm-materia').value;
            payload.url = document.getElementById('adm-url').value;
        } else {
            payload.titulo = document.getElementById('adm-titulo').value;
            payload.mensagem = document.getElementById('adm-msg').value;
        }
        status.innerText = "‚è≥ Enviando...";
        try {
            await fetch(URL_API, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            status.innerText = "‚úÖ Publicado com sucesso!";
            setTimeout(fecharModal, 1500);
        } catch(e) { status.innerText = "‚ùå Erro ao enviar."; }
    }

    // --- FUN√á√ïES DE EXIBI√á√ÉO (MANTIDAS) ---
    function abrirGrade() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Grade de Aulas";
        corpo.innerHTML = "";
        const itens = dadosApp["Grade"] || [];
        const ordem = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado", "Domingo"];
        const dias = [...new Set(itens.map(a => a["Dia da Semana"]))].sort((a,b) => ordem.findIndex(d => a.includes(d)) - ordem.findIndex(d => b.includes(d)));
        dias.forEach(dia => {
            const aulas = itens.filter(a => a["Dia da Semana"] === dia && a["Mat√©ria"] && a["Mat√©ria"].trim() !== "");
            let html = aulas.length === 0 ? `<div class="item-aguardando"><span>‚è≥</span><span>Aguardando a libera√ß√£o das aulas...</span></div>` :
                aulas.map(a => `<div class="grade-item"><div class="grade-hora">${a["Hor√°rios"]}</div><div style="flex:1; text-align:left;"><b>${a["Mat√©ria"]}</b><br><small style="opacity:0.6">üë• ${a["Grupo"] || 'Geral'}</small></div></div>`).join('');
            corpo.innerHTML += `<details class="secao-retratil"><summary class="secao-titulo"><span>${dia}</span><span>‚ñº</span></summary><div>${html}</div></details>`;
        });
        document.getElementById('meuModal').style.display = 'flex';
    }

    function abrirGrupos() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Grupos";
        corpo.innerHTML = `<input type="text" id="buscag" placeholder="üîç Buscar..." style="width:100%; padding:14px; border-radius:12px; background:var(--input-bg); color:white; border:1px solid #444; margin-bottom:15px;" onkeyup="filtrarG()"> <div id="cg"></div>`;
        renderGrupos(dadosApp["Grupos"] || []);
        document.getElementById('meuModal').style.display = 'flex';
    }

    function renderGrupos(lista) {
        const container = document.getElementById('cg'); container.innerHTML = "";
        const mats = [...new Set(lista.map(i => i["Mat√©ria"]))];
        mats.forEach(m => {
            const gMat = lista.filter(i => i["Mat√©ria"] === m);
            const nomes = [...new Set(gMat.map(g => g["Nome do Grupo"]))];
            let h = nomes.map(ng => {
                const mb = gMat.filter(g => g["Nome do Grupo"] === ng).map(m => `<li>${m["Integrantes"]}</li>`).join('');
                return `<details style="margin:5px 0; border:1px solid #333; border-radius:8px;"><summary style="padding:10px; font-weight:bold; cursor:pointer; text-align:left; display:block;">${ng}</summary><ul style="font-size:0.85em; color:#bbb; padding-bottom:10px; text-align: left;">${mb}</ul></details>`;
            }).join('');
            container.innerHTML += `<details class="secao-retratil"><summary class="secao-titulo"><span>${m}</span><span>‚ñº</span></summary><div style="padding:5px 10px; text-align: left;">${h}</div></details>`;
        });
    }

    function abrirArquivos() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Arquivos";
        corpo.innerHTML = "";
        const itens = dadosApp["Arquivos"] || [];
        [...new Set(itens.map(i => i["Nome"]))].forEach(n => {
            const links = itens.filter(i => i["Nome"] === n);
            let html = links.map(a => (!a["Links"] || a["Links"] === "#") ? `<div class="item-aguardando"><span>${a["Descri√ß√£o"]}</span><span>‚è≥</span></div>` : `<a href="${a["Links"]}" target="_blank" class="item-lista-link"><b>${a["Descri√ß√£o"]}</b><span>üìÇ</span></a>`).join('');
            corpo.innerHTML += `<details class="secao-retratil"><summary class="secao-titulo"><span>${n}</span><span>‚ñº</span></summary><div style="padding:10px;">${html}</div></details>`;
        });
        document.getElementById('meuModal').style.display = 'flex';
    }

    function abrirAvisos() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Avisos Recentes";
        const itens = (dadosApp["Avisos"] || []).slice().reverse();
        corpo.innerHTML = itens.length === 0 ? "<p style='text-align:left;'>Sem avisos.</p>" : itens.map(i => `<div style="background:rgba(0,123,255,0.05); padding:15px; border-radius:15px; margin-bottom:12px; border-left:4px solid var(--p-med); text-align:left;"><small style="color:#888;">${i["Data"]}</small><br><b style="color:var(--p-med);">${i["Titulo"]}</b><p style="font-size:0.9em; margin-top:5px; white-space:pre-wrap;">${i["Mensagem"]}</p></div>`).join('');
        localStorage.setItem('avisos_lidos', (dadosApp["Avisos"] || []).length);
        document.getElementById('aviso-badge').style.display = 'none';
        document.getElementById('meuModal').style.display = 'flex';
    }

    function abrirLinks() {
        const corpo = document.getElementById('modal-corpo');
        document.getElementById('modal-titulo').innerText = "Aulas Online";
        const itens = dadosApp["Links"] || [];
        corpo.innerHTML = itens.length === 0 ? "<p style='text-align:left;'>Nenhuma aula agendada.</p>" : itens.map(i => `
            <div style="padding:15px; background:var(--input-bg); border-radius:15px; margin-bottom:10px; text-align:left;">
                <b>${i["Materia"] || i["Mat√©ria"]}</b><br>
                <small style="opacity:0.7;">üóìÔ∏è ${i["Data"]} - ${i["Hor√°rio"] || i["Horario"]}</small>
                <a href="${i["Url"] || i["URL"]}" target="_blank" style="display:block; background:var(--p-med); color:white; text-align:center; padding:12px; border-radius:10px; margin-top:10px; text-decoration:none; font-weight:bold;">ACESSAR GRUPO</a>
            </div>`).join('');
        document.getElementById('meuModal').style.display = 'flex';
    }

    function filtrarG() {
        const t = document.getElementById('buscag').value.toLowerCase();
        const f = (dadosApp["Grupos"] || []).filter(g => JSON.stringify(g).toLowerCase().includes(t));
        renderGrupos(f);
    }

    function setupPullToRefresh() {
        let touchStart = 0;
        const ptr = document.getElementById('ptr');
        window.addEventListener('touchstart', e => { if (window.scrollY === 0) touchStart = e.touches[0].pageY; }, {passive: true});
        window.addEventListener('touchmove', e => {
            let touchMove = e.touches[0].pageY;
            if (window.scrollY === 0 && touchMove > touchStart) {
                let dist = touchMove - touchStart;
                if (dist > 5 && dist < 70) {
                    ptr.style.height = dist + 'px';
                    if (dist > 50) ptr.innerText = "Solte para atualizar...";
                }
            }
        }, {passive: true});
        window.addEventListener('touchend', () => {
            if (parseInt(ptr.style.height) > 50) carregarDados();
            ptr.style.height = '0';
        });
    }
</script>
</body>
</html>





